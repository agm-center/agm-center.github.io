import{_}from"./preload-helper.BlTxHScW.js";document.addEventListener("DOMContentLoaded",()=>{const c=document.getElementById("download-form"),p=document.getElementById("consent-form"),d=document.getElementById("download-links"),m=document.getElementById("submit-btn"),u=document.getElementById("submit-text"),g=document.getElementById("loading-text"),y=document.getElementById("license-id");function f(){return"KPG-"+Date.now().toString(36).toUpperCase()+"-"+Math.random().toString(36).substr(2,5).toUpperCase()}c.addEventListener("submit",async l=>{l.preventDefault(),m.disabled=!0,u.classList.add("hidden"),g.classList.remove("hidden");try{const e=new FormData(c),o=f(),t={name:e.get("name"),email:e.get("email"),organization:e.get("organization"),purpose:e.get("purpose"),app_id:"kpg-view",license_id:o,timestamp:new Date().toISOString(),user_agent:navigator.userAgent,agreements:{non_commercial:e.get("non-commercial")==="on",no_redistribution:e.get("no-redistribution")==="on"}};let a=!1;try{const{createClient:n}=await _(async()=>{const{createClient:I}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:I}},[]),s=n("https://ydlrwyjwrrntwesyomok.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbHJ3eWp3cnJudHdlc3lvbW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDIzMjMsImV4cCI6MjA4MTE3ODMyM30.IkeX2A21uDMGR3EgsgVu_Fu22niKxyjek73GA7OTCoY"),i={app_id:t.app_id,license_id:t.license_id,user_info:{name:t.name,email:t.email,organization:t.organization,purpose:t.purpose||null},agreements:t.agreements,metadata:{user_agent:t.user_agent,ip_address:null,referrer:document.referrer||null}},{error:r}=await s.from("consents").insert(i);if(r)throw console.error("Supabase error:",r),r;console.log("✅ Consent saved to database"),a=!0}catch(n){console.warn("❌ Database save failed, storing locally:",n),a=!1}localStorage.setItem("kpg_consent_data",JSON.stringify(t)),localStorage.setItem("kpg_license_id",o),localStorage.setItem("kpg_db_saved",a.toString()),p.classList.add("hidden"),d.classList.remove("hidden"),y.textContent=o,d.scrollIntoView({behavior:"smooth"})}catch(e){console.error("Error processing form:",e),alert("An error occurred while processing your request. Please try again.")}finally{m.disabled=!1,u.classList.remove("hidden"),g.classList.add("hidden")}}),document.querySelectorAll(".download-link").forEach(l=>{l.addEventListener("click",async e=>{e.preventDefault();const o=e.currentTarget,t=o.dataset.fileKey,a=localStorage.getItem("kpg_license_id");if(!a){alert("License ID not found. Please complete the agreement first.");return}try{o.setAttribute("aria-busy","true");const n=await fetch("https://ydlrwyjwrrntwesyomok.supabase.co/functions/v1/request-download",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({license_id:a,file_key:t})});if(!n.ok){let i=`Download request failed (${n.status}).`;try{const r=await n.json();r?.error&&(i=r.error)}catch{}alert(i);return}const{url:s}=await n.json();if(!s){alert("No download URL returned.");return}window.location.href=s}catch(n){console.error(n),alert("Network error. Please try again.")}finally{o.removeAttribute("aria-busy")}})})});
