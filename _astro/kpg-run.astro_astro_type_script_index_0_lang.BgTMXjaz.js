import{_ as w}from"./preload-helper.BlTxHScW.js";document.addEventListener("DOMContentLoaded",()=>{const p=document.getElementById("download-form"),y=document.getElementById("consent-form"),i=document.getElementById("download-links"),I=document.getElementById("submit-btn"),_=document.getElementById("submit-text"),b=document.getElementById("loading-text"),f=document.getElementById("license-id");function S(){return"KPG-"+Date.now().toString(36).toUpperCase()+"-"+Math.random().toString(36).substr(2,5).toUpperCase()}p.addEventListener("submit",async l=>{l.preventDefault(),I.disabled=!0,_.classList.add("hidden"),b.classList.remove("hidden");try{const t=new FormData(p),r=S(),e={name:t.get("name"),email:t.get("email"),organization:t.get("organization"),purpose:t.get("purpose"),app_id:"kpg-run",license_id:r,timestamp:new Date().toISOString(),user_agent:navigator.userAgent,agreements:{non_commercial:t.get("non-commercial")==="on",no_redistribution:t.get("no-redistribution")==="on"}};let n=!1;try{const{createClient:o}=await w(async()=>{const{createClient:u}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:u}},[]),c=o("https://ydlrwyjwrrntwesyomok.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbHJ3eWp3cnJudHdlc3lvbW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDIzMjMsImV4cCI6MjA4MTE3ODMyM30.IkeX2A21uDMGR3EgsgVu_Fu22niKxyjek73GA7OTCoY"),m={app_id:e.app_id,license_id:e.license_id,user_info:{name:e.name,email:e.email,organization:e.organization,purpose:e.purpose||null},agreements:e.agreements,metadata:{user_agent:e.user_agent,ip_address:null,referrer:document.referrer||null}},{data:g,error:a}=await c.from("consents").insert(m).select().single();if(a)throw console.error("Supabase error:",a),a;console.log("✅ Consent saved to database:",g.id),n=!0}catch(o){console.warn("❌ Database save failed, storing locally:",o),n=!1}localStorage.setItem("kpg_consent_data",JSON.stringify(e)),localStorage.setItem("kpg_license_id",r),localStorage.setItem("kpg_db_saved",n.toString()),y.classList.add("hidden"),i.classList.remove("hidden"),f.textContent=r;const s=document.createElement("div");s.className=`mt-4 p-3 rounded-lg text-sm ${n?"bg-green-50 text-green-700 border border-green-200":"bg-yellow-50 text-yellow-700 border border-yellow-200"}`,s.innerHTML=n?"✅ 데이터가 데이터베이스에 성공적으로 저장되었습니다.":"⚠️ 데이터베이스 연결에 실패했지만 로컬에 저장되었습니다.";const d=i.querySelector(".bg-green-50");d&&d.appendChild(s),i.scrollIntoView({behavior:"smooth"})}catch(t){console.error("Error processing form:",t),alert("An error occurred while processing your request. Please try again.")}finally{I.disabled=!1,_.classList.remove("hidden"),b.classList.add("hidden")}}),document.querySelectorAll(".download-link").forEach(l=>{l.addEventListener("click",async t=>{const r=t.target.closest(".download-link").dataset.appId,e=localStorage.getItem("kpg_license_id"),n={app_id:r,license_id:e,timestamp:new Date().toISOString(),user_agent:navigator.userAgent};let s=!1;try{const{createClient:o}=await w(async()=>{const{createClient:u}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:u}},[]),c=o("https://ydlrwyjwrrntwesyomok.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbHJ3eWp3cnJudHdlc3lvbW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDIzMjMsImV4cCI6MjA4MTE3ODMyM30.IkeX2A21uDMGR3EgsgVu_Fu22niKxyjek73GA7OTCoY"),m={app_id:r,license_id:e,metadata:{user_agent:navigator.userAgent,ip_address:null,referrer:document.referrer||null}},{data:g,error:a}=await c.from("download_clicks").insert(m).select().single();if(a)throw console.error("Download Supabase error:",a),a;console.log("✅ Download click saved to database:",g.id),s=!0}catch(o){console.warn("❌ Download database save failed:",o),s=!1}const d=JSON.parse(localStorage.getItem("kpg_download_records")||"[]");d.push(n),localStorage.setItem("kpg_download_records",JSON.stringify(d)),console.log("Download recorded locally:",n)})})});
