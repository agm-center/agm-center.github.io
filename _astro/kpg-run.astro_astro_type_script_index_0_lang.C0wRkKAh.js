import{_ as w}from"./preload-helper.BlTxHScW.js";document.addEventListener("DOMContentLoaded",()=>{const g=document.getElementById("download-form"),y=document.getElementById("consent-form"),u=document.getElementById("download-links"),p=document.getElementById("submit-btn"),I=document.getElementById("submit-text"),_=document.getElementById("loading-text"),b=document.getElementById("license-id");function f(){return"KPG-"+Date.now().toString(36).toUpperCase()+"-"+Math.random().toString(36).substr(2,5).toUpperCase()}g.addEventListener("submit",async d=>{d.preventDefault(),p.disabled=!0,I.classList.add("hidden"),_.classList.remove("hidden");try{const t=new FormData(g),n=f(),e={name:t.get("name"),email:t.get("email"),organization:t.get("organization"),purpose:t.get("purpose"),app_id:"kpg-run",license_id:n,timestamp:new Date().toISOString(),user_agent:navigator.userAgent,agreements:{non_commercial:t.get("non-commercial")==="on",no_redistribution:t.get("no-redistribution")==="on"}};let o=!1;try{const{createClient:a}=await w(async()=>{const{createClient:l}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:l}},[]),i=a("https://ydlrwyjwrrntwesyomok.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbHJ3eWp3cnJudHdlc3lvbW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDIzMjMsImV4cCI6MjA4MTE3ODMyM30.IkeX2A21uDMGR3EgsgVu_Fu22niKxyjek73GA7OTCoY"),s={app_id:e.app_id,license_id:e.license_id,user_info:{name:e.name,email:e.email,organization:e.organization,purpose:e.purpose||null},agreements:e.agreements,metadata:{user_agent:e.user_agent,ip_address:null,referrer:document.referrer||null}},{data:c,error:r}=await i.from("consents").insert(s).select().single();if(r)throw console.error("Supabase error:",r),r;console.log("✅ Consent saved to database:",c.id),o=!0}catch(a){console.warn("❌ Database save failed, storing locally:",a),o=!1}localStorage.setItem("kpg_consent_data",JSON.stringify(e)),localStorage.setItem("kpg_license_id",n),localStorage.setItem("kpg_db_saved",o.toString()),y.classList.add("hidden"),u.classList.remove("hidden"),b.textContent=n,u.scrollIntoView({behavior:"smooth"})}catch(t){console.error("Error processing form:",t),alert("An error occurred while processing your request. Please try again.")}finally{p.disabled=!1,I.classList.remove("hidden"),_.classList.add("hidden")}}),document.querySelectorAll(".download-link").forEach(d=>{d.addEventListener("click",async t=>{const n=t.target.closest(".download-link").dataset.appId,e=localStorage.getItem("kpg_license_id"),o={app_id:n,license_id:e,timestamp:new Date().toISOString(),user_agent:navigator.userAgent};let a=!1;try{const{createClient:s}=await w(async()=>{const{createClient:S}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:S}},[]),c=s("https://ydlrwyjwrrntwesyomok.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkbHJ3eWp3cnJudHdlc3lvbW9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDIzMjMsImV4cCI6MjA4MTE3ODMyM30.IkeX2A21uDMGR3EgsgVu_Fu22niKxyjek73GA7OTCoY"),r={app_id:n,license_id:e,metadata:{user_agent:navigator.userAgent,ip_address:null,referrer:document.referrer||null}},{data:l,error:m}=await c.from("download_clicks").insert(r).select().single();if(m)throw console.error("Download Supabase error:",m),m;console.log("✅ Download click saved to database:",l.id),a=!0}catch(s){console.warn("❌ Download database save failed:",s),a=!1}const i=JSON.parse(localStorage.getItem("kpg_download_records")||"[]");i.push(o),localStorage.setItem("kpg_download_records",JSON.stringify(i)),console.log("Download recorded locally:",o)})})});
