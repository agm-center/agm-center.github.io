<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>GeoJSON Viewer with Search</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: sans-serif; }
    #map { position: absolute; top: 80px; bottom: 0; left: 0; right: 0; }
    #top-bar {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: #fff;
      border-bottom: 1px solid #ccc;
      padding: 8px 12px;
      z-index: 1000;
    }
    #search-results {
      margin-top: 4px;
      max-height: 140px;
      overflow-y: auto;
      font-size: 14px;
      position: absolute;
      left: 320px;
      top: 42px;
      background: #fff;
      z-index: 1001;
      width: calc(100% - 330px);
      border: 1px solid #ccc;
    }
    .result {
      cursor: pointer;
      padding: 3px 6px;
      border-radius: 4px;
    }
    .result:hover, .result.active {
      background: #cce0ff;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>

<div id="top-bar">
  <input type="file" id="upload" accept=".geojson,.json" />
  <input type="text" id="search" placeholder="Search..." style="position: absolute; right: 12px; top: 8px; width: 280px;" />
  <div id="search-results"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([36.5, 127.5], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & Carto',
    subdomains: 'abcd',
    maxZoom: 19,
  }).addTo(map);

  const zoomHome = L.control({ position: 'topleft' });
  zoomHome.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
    const btn = L.DomUtil.create('a', '', div);
    btn.innerHTML = 'â¤¢';
    btn.title = 'Reset Zoom';
    btn.href = '#';
    btn.style.fontSize = '18px';
    btn.style.lineHeight = '26px';
    btn.style.textAlign = 'center';
    btn.style.padding = '0 4px';
    btn.onclick = function(e) {
      e.preventDefault();
      if (geoLayer) map.fitBounds(geoLayer.getBounds());
    };
    return div;
  };
  zoomHome.addTo(map);

  let geoLayer, allFeatures = [];
  let activeIndex = -1;
  let lastHighlightedLayer = null;
  let matches = [];

  document.getElementById('upload').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const geojson = JSON.parse(event.target.result);
      if (geoLayer) map.removeLayer(geoLayer);

      allFeatures = []; // clear previous

      geoLayer = L.geoJSON(geojson, {
        style: feature => {
          if (feature.geometry.type === 'LineString') {
            const color = Array.isArray(feature.properties?.lineColor)
              ? `rgb(${feature.properties.lineColor.join(',')})`
              : '#3388ff';
            return {
              color,
              weight: feature.properties?.lineWidth || 2,
              opacity: 1,
            };
          }
          return {};
        },
        pointToLayer: (feature, latlng) => {
          const props = feature.properties || {};
          const fillColor = Array.isArray(props.fillColor)
            ? `rgb(${props.fillColor.join(',')})`
            : '#3388ff';
          const radius = props.radius ? props.radius / 500 : 4;
          return L.circleMarker(latlng, {
            radius,
            fillColor,
            color: '#000',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9,
          });
        },
        onEachFeature: (feature, layer) => {
          const p = feature.properties || {};
          let popup = `<strong>${p.name || 'Unnamed'}</strong><br/><br/>`;
          if (p.PSSE_ID) popup += `<b>PSSE_ID:</b> ${p.PSSE_ID}<br/>`;
          if (p.direction) popup += `<b>Direction:</b> ${p.direction}<br/>`;
          if (p.voltage) popup += `<b>Voltage:</b> ${p.voltage} kV<br/>`;
          if (p.flow_P) popup += `<b>flow_P:</b> ${p.flow_P}<br/>`;
          if (p.flow_Q) popup += `<b>flow_Q:</b> ${p.flow_Q}<br/>`;
          if (p.loading) popup += `<b>Loading:</b> ${p.loading}<br/>`;
          if (p.num_lines) popup += `<b># of Lines:</b> ${p.num_lines}<br/>`;
          if (p.busType) popup += `<b>Bus Type:</b> ${p.busType}<br/>`;
          if (p.P_inj) popup += `<b>P_inj:</b> ${p.P_inj}<br/>`;
          if (p.Q_inj) popup += `<b>Q_inj:</b> ${p.Q_inj}<br/>`;
          if (p.MVA_inj) popup += `<b>MVA_inj:</b> ${p.MVA_inj}<br/>`;
          layer.bindPopup(popup);
          allFeatures.push({ feature, layer });
        }
      }).addTo(map);

      map.fitBounds(geoLayer.getBounds());
    };
    reader.readAsText(file);
  });

  document.getElementById('search').addEventListener('input', function () {
    const query = this.value.trim().toLowerCase();
    const container = document.getElementById('search-results');
    container.innerHTML = '';
    activeIndex = -1;

    if (!query || allFeatures.length === 0) return;

    matches = allFeatures.filter(({ feature }) => {
      const p = feature.properties || {};
      return (p.name || '').toLowerCase().includes(query)
        || (p.PSSE_ID || '').toLowerCase().includes(query)
        || (p.direction || '').toLowerCase().includes(query);
    });

    container.dataset.matchLength = matches.length;

    matches.slice(0, 50).forEach(({ feature, layer }, i) => {
      const div = document.createElement('div');
      const props = feature.properties || {};
      div.className = 'result';
      div.innerText = `${props.name || '[Unnamed]'} (${props.PSSE_ID || 'no ID'})`;
      div.dataset.index = i;

      div.addEventListener('mouseenter', () => {
        highlightLayer(layer);
        setActiveItem(i);
      });
      div.addEventListener('mouseleave', () => {
        clearHighlight(layer);
        clearActiveItem();
      });

      div.onclick = () => {
        zoomAndBlink(layer);
        layer.openPopup();
      };

      container.appendChild(div);
    });
  });

  function setActiveItem(index) {
    const container = document.getElementById('search-results');
    const prev = container.querySelector('.result.active');
    if (prev) prev.classList.remove('active');
    const next = container.querySelector(`.result[data-index="${index}"]`);
    if (next) next.classList.add('active');

    if (activeIndex !== -1 && matches[activeIndex] && activeIndex !== index) {
      clearHighlight(matches[activeIndex].layer);
    }
    activeIndex = index;
    if (matches[index]) keyboardHighlightLayer(matches[index].layer);
  }

  function clearActiveItem() {
    const container = document.getElementById('search-results');
    const prev = container.querySelector('.result.active');
    if (prev) prev.classList.remove('active');
    if (lastHighlightedLayer) clearHighlight(lastHighlightedLayer);
    lastHighlightedLayer = null;
    activeIndex = -1;
  }

  document.getElementById('search').addEventListener('keydown', function (e) {
    const container = document.getElementById('search-results');
    const listLen = parseInt(container.dataset.matchLength || 0);
    if (!listLen) return;

    const results = container.querySelectorAll('.result');

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      activeIndex = (activeIndex + 1) % listLen;
      setActiveItem(activeIndex);
      results[activeIndex]?.scrollIntoView({ block: 'nearest' });
    }

    if (e.key === 'ArrowUp') {
      e.preventDefault();
      activeIndex = (activeIndex - 1 + listLen) % listLen;
      setActiveItem(activeIndex);
      results[activeIndex]?.scrollIntoView({ block: 'nearest' });
    }

    if (e.key === 'Enter' && results[activeIndex]) {
      results[activeIndex].click();
      document.getElementById('search').value = '';
      container.innerHTML = '';
    }
  });

  function flashLayer(layer) {
    if (!layer.setStyle) return;
    const original = { ...layer.options };
    layer.setStyle({ color: 'orange', weight: 5 });
    setTimeout(() => layer.setStyle(original), 500);
    setTimeout(() => layer.setStyle({ color: 'red', weight: 5 }), 1000);
    setTimeout(() => layer.setStyle(original), 1500);
  }

  function zoomAndBlink(layer) {
    const bounds = layer.getBounds ? layer.getBounds() : L.latLngBounds([layer.getLatLng()]);
    map.fitBounds(bounds.pad(0.3));
    flashLayer(layer);
  }

  function highlightLayer(layer) {
    if (!layer.setStyle) return;
    if (lastHighlightedLayer && lastHighlightedLayer !== layer) {
      clearHighlight(lastHighlightedLayer);
    }
    lastHighlightedLayer = layer;
    layer.setStyle({ color: 'orange', weight: 5 });
  }

  function keyboardHighlightLayer(layer) {
    if (!layer.setStyle) return;
    if (lastHighlightedLayer && lastHighlightedLayer !== layer) {
      clearHighlight(lastHighlightedLayer);
    }
    lastHighlightedLayer = layer;
    layer.setStyle({ color: 'orange', weight: 5 });
  }

  function clearHighlight(layer) {
    if (!layer.setStyle) return;
    const originalColor = Array.isArray(layer.feature?.properties?.lineColor)
      ? `rgb(${layer.feature.properties.lineColor.join(',')})`
      : '#3388ff';
    layer.setStyle({ color: originalColor, weight: layer.feature?.properties?.lineWidth || 2 });
  }
</script>

</body>
</html>